services:
  # Primary OLTP PostgreSQL
  postgres:
    image: postgres:16
    environment:
      POSTGRES_USER: user
      POSTGRES_PASSWORD: pass
      POSTGRES_DB: oltp_db
      PGDATA: /var/lib/postgresql/data
    ports:
      - "5432:5432"
    volumes:
      - ./db/init:/docker-entrypoint-initdb.d
      - ./db/config/primary/postgresql.conf:/docker-entrypoint-initdb.d/postgresql.conf:ro
      - ./db/config/primary/pg_hba.conf:/docker-entrypoint-initdb.d/pg_hba.conf:ro
      - ./postgres_data/oltp:/var/lib/postgresql/data

  # Streaming replica
  postgres_replica:
    image: postgres:16
    depends_on:
      - postgres
    environment:
      POSTGRES_USER: replicator
      POSTGRES_PASSWORD: replicator_pass
      PGDATA: /var/lib/postgresql/data
      POSTGRES_DB: oltp_db
    ports:
      - "5435:5432"
    volumes:
      - ./db/replication:/docker-entrypoint-initdb.d
      - ./db/config/replica/postgresql.conf:/docker-entrypoint-initdb.d/postgresql.conf:ro
      - ./db/config/replica/pg_hba.conf:/docker-entrypoint-initdb.d/pg_hba.conf:ro
      - ./postgres_data/replica:/var/lib/postgresql/data
    command: >
      sh -c '
      cp /docker-entrypoint-initdb.d/postgresql.conf $PGDATA/postgresql.conf &&
      cp /docker-entrypoint-initdb.d/pg_hba.conf     $PGDATA/pg_hba.conf &&
      chmod 600 $PGDATA/postgresql.conf &&
      chmod 600 $PGDATA/pg_hba.conf &&
      exec docker-entrypoint.sh postgres
      '

  # Apache Doris 
  doris:
    image: apache/doris:doris-all-in-one-2.1.0
    container_name: doris
    hostname: doris
    ports:
      - "8030:8030"    
      - "9030:9030"    
      - "9037:9037"  
      - "8040:8040"   
      - "9060:9060"   
    volumes:
      - ./doris/fe/meta:/opt/apache-doris/fe/doris-meta   
      - ./doris/be/storage:/opt/apache-doris/be/storage   
      - ./doris/logs:/opt/apache-doris/log               

  # pgvector
  postgres-vector:
    image: ankane/pgvector
    environment:
      POSTGRES_USER: vector_user
      POSTGRES_PASSWORD: vector_pass
      POSTGRES_DB: vector_db
    ports:
      - "5434:5432"
    volumes:
      - ./postgres_data/vector:/var/lib/postgresql/data

  # Redis
  redis:
    image: redis:7
    ports:
      - "6379:6379"
    volumes:
      - ./redis_data:/data

  # Apache Airflow (explicit tag)
  airflow:
    image: apache/airflow:2.10.5
    command: >
      bash -c "airflow db upgrade &&
      airflow users create --username myadmin --firstname FirstName --lastname LastName --role Admin --email myadmin@example.com --password mypassword || true &&
      airflow standalone"
    environment:
      AIRFLOW__CORE__EXECUTOR: LocalExecutor
      AIRFLOW__DATABASE__SQL_ALCHEMY_CONN: postgresql+psycopg2://user:pass@postgres:5432/oltp_db
      FLASK_LIMITER_STORAGE_URL: redis://redis:6379/0
    ports:
      - "8081:8080"
    volumes:
      - ./dags:/opt/airflow/dags

  # Apache Superset (use valid tag)
  superset:
    image: apache/superset:latest
    command: >
      bash -c "superset db upgrade &&
      superset fab create-admin --username myadmin --firstname Admin --lastname User --email admin@example.com --password myadmin || true &&
      superset init &&
      superset run -p 8088 --host 0.0.0.0 --with-threads --reload --debugger"
    environment:
      SUPERSET_ENV: production
      SUPERSET_LOAD_EXAMPLES: "no"
      SUPERSET_SECRET_KEY: "password"
      FLASK_LIMITER_STORAGE_URL: redis://redis:6379/0
    ports:
      - "8088:8088"
    volumes:
      - ./superset_data:/app/superset_home

  # pgAdmin (pin to latest)
  pgadmin:
    image: dpage/pgadmin4:latest
    environment:
      PGADMIN_DEFAULT_EMAIL: admin@admin.com
      PGADMIN_DEFAULT_PASSWORD: admin
    ports:
      - "5050:80"
    volumes:
      - ./pgadmin_data:/var/lib/pgadmin

networks:
  adat_net:
    driver: bridge